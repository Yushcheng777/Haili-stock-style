name: Generate Backtest Report

on:
  workflow_dispatch:
    inputs:
      equity_curve_path:
        description: 'Path to equity curve CSV file'
        required: true
        default: 'backtest_results/equity_curve.csv'
  push:
    paths:
      - 'backtest_results/equity_curve.csv'

env:
  DEFAULT_EQUITY_PATH: backtest_results/equity_curve.csv

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install base dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy matplotlib jinja2

      - name: Install optional dependencies (soft fail)
        run: |
          pip install markdown weasyprint reportlab || true

      - name: Resolve equity path
        # If triggered by workflow_dispatch, use the provided input; otherwise fallback to default
        env:
          INPUT_PATH: ${{ github.event.inputs.equity_curve_path }}
          DEFAULT_PATH: ${{ env.DEFAULT_EQUITY_PATH }}
        run: |
          EQUITY_PATH="${INPUT_PATH:-$DEFAULT_PATH}"
          echo "Resolved EQUITY_PATH: $EQUITY_PATH"
          echo "EQUITY_PATH=$EQUITY_PATH" >> "$GITHUB_ENV"

      - name: Check if equity curve exists (create sample if missing)
        run: |
          if [ ! -f "$EQUITY_PATH" ]; then
            echo "Equity curve file not found: $EQUITY_PATH"
            echo "Creating sample data for demonstration..."
            mkdir -p "$(dirname "$EQUITY_PATH")"
            python - << 'PY'
          import os
          import pandas as pd
          import numpy as np

          equity_path = os.environ.get("EQUITY_PATH", "backtest_results/equity_curve.csv")
          os.makedirs(os.path.dirname(equity_path), exist_ok=True)
          
          # Generate sample equity curve data
          dates = pd.date_range(start='2023-01-01', end='2023-12-31', freq='D')
          # Simulate portfolio growth with some volatility
          returns = np.random.normal(0.0005, 0.02, len(dates))  # ~0.05% daily mean with 2% vol
          portfolio_values = [100000.0]  # Start with $100k
          for ret in returns[1:]:
              portfolio_values.append(portfolio_values[-1] * (1.0 + ret))
          
          df = pd.DataFrame({
              'Date': dates,
              'PortfolioValue': portfolio_values
          })
          df.to_csv(equity_path, index=False)
          print(f"Created sample equity curve at: {equity_path}")
          PY
          fi

      - name: Generate backtest report
        run: |
          python generate_backtest_report.py --input-dir backtest_results

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backtest-report
          path: |
            backtest_results/report.md
            backtest_results/report.html
            backtest_results/report.pdf
            backtest_results/metrics.json
            backtest_results/charts/
          if-no-files-found: ignore

      - name: Create PR with results (if changed)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add backtest_results/
          if git diff --staged --quiet; then
            echo "No changes to commit - skipping PR creation"
          else
            # Create a unique branch name
            BRANCH_NAME="report-update-${{ github.run_id }}"
            echo "Creating branch: $BRANCH_NAME"
            
            # Create and switch to new branch
            git checkout -b "$BRANCH_NAME"
            
            # Commit changes
            git commit -m "Update backtest report - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            # Push the branch
            git push origin "$BRANCH_NAME"
            
            # Create pull request using GitHub CLI
            gh pr create \
              --title "ðŸ“Š Automated Backtest Report Update" \
              --body "This is an automated update of the backtest report generated by the workflow.
            
            **Run ID:** ${{ github.run_id }}
            **Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            **Triggered by:** ${{ github.event_name }}
            
            The report includes:
            - Updated backtest results
            - Generated charts and visualizations
            - Performance metrics and analysis
            
            Please review the changes before merging." \
              --head "$BRANCH_NAME" \
              --base main
            
            echo "âœ… Pull request created successfully for branch: $BRANCH_NAME"
          fi